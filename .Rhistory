## L: an abundance data table, here taken from a negative binomial (10 communities x 5 species)
## T: a vector with a trait measured for the species (vector t in the paper)
## E: a vector with an environmental variable (vector e in the paper)
print(traits_to_plot[i])
L <- as.matrix(abund)
T <- as.vector(traits[, i])
i
traits
traits_to_plot
for(i in 1:length(traits_to_plot)){
#
################################
## From Peres-Neto et al. 2017
################################
## L: an abundance data table, here taken from a negative binomial (10 communities x 5 species)
## T: a vector with a trait measured for the species (vector t in the paper)
## E: a vector with an environmental variable (vector e in the paper)
print(traits_to_plot[i])
L <- as.matrix(abund)
T <- as.vector(traits[, eval(substitute(traits_to_plot[i]))])
E <- as.vector(plot_agg_traits$BA)
## compute communities (Wn) and species weights (Ws)
Wn <- rowSums(L) / sum(L)
Ws <- colSums(L) / sum(L)
########################################
## compute standard SNC/CWM correlations
########################################
## compute standard CWM (vector c in the paper)
CWM <- apply(L, 1, function(x) weighted.mean(T, w = x, na.rm = TRUE))
## compute standard correlation between CWM and E
print(cor.test(CWM, E))
## compute standard SNC
SNC <- apply(L, 2, function(x) weighted.mean(E, w = x))
## compute standard correlation between SNC and T
print(cor.test(SNC, T, na.rm = TRUE))
}
i
## L: an abundance data table, here taken from a negative binomial (10 communities x 5 species)
## T: a vector with a trait measured for the species (vector t in the paper)
## E: a vector with an environmental variable (vector e in the paper)
print(traits_to_plot[i])
traits_to_plot[i]
traits[, eval(substitute(traits_to_plot[i]))]
eval(substitute(traits_to_plot[i]))
names(traits)
traits
clean_species
## Bivariate and ordination analysis
# TODO
# load libraries
library("ggplot2")
library("plyr")
library("vegan")
library("multcomp")
library("multcompView")
library("pca3d")
library("effects")
library("plotrix")
library("ape")
library("cluster")
library("FD")
setwd("C:\\Users\\Sam\\Google Drive\\Projects\\Savanna traits")
set.seed(45750762)
#----------------------------------------------------------------------------
# Function to plot elliptical hulls for phylogenetic PCA,
# modified from vegan::ordiellipse. I removed a bunch of functionality,
# so now it only draws elliptical hulls
#----------------------------------------------------------------------------
phyellipse <- function (ord, groups, display = "sites",
col = NULL,
show.groups, choices = c(1,2), ...)
{
pts <- ord$S
pts <- as.matrix(pts)
pts <- pts[, choices, drop = FALSE]
take <- groups %in% show.groups
pts <- pts[take, , drop = FALSE]
tmp <- ellipsoidhull(pts)
lines(predict(tmp), col = col)
}
#----------------------------------------------------------------------------
# Import and wrangle data
#----------------------------------------------------------------------------
#read data
clean_species <- read.csv("./clean data/clean_species2018-11-07.csv")
plot_data <- read.csv("./Clean data/plot_data2018-11-07.csv")
plot_data <- subset(plot_data, !is.na(CSA_30))
bark_model <- readRDS("./clean data/bark_model.RDS")
bark_model_fg <- readRDS("./clean data/bark_model_fg.RDS")
clean_species$FG <- factor(clean_species$FG,levels(clean_species$FG)[c(3,2,1)])
clean_species$Leaf_size <- clean_species$Leaf_size/100
clean_species$Total_leaf_size <- clean_species$Total_leaf_size/100
clean_species_reduced <- clean_species[complete.cases(clean_species), ]
clean_species_reduced <- clean_species_reduced[clean_species_reduced$Habit %in% c("Tree", "tree", "Treelet", "treelet"), ]
#### Transformations
#exploration
# hist(clean_species_reduced$Leaf_size)
# hist(log(clean_species_reduced$Leaf_size)) #yes
# hist(clean_species_reduced$Total_leaf_size)
# hist(log(clean_species_reduced$Total_leaf_size)) #yes
# hist(clean_species_reduced$Leaf_thickness)
# hist(log(clean_species_reduced$Leaf_thickness)) #yes
# hist(clean_species_reduced$Max_height)#no
# hist(clean_species_reduced$Height_at_5cm)#no
# hist(clean_species_reduced$Crown_ratio)#no
# hist(clean_species_reduced$Light_at_5cm)#no
# hist(clean_species_reduced$SLA)
# hist(log(clean_species_reduced$SLA))#yes
# hist(clean_species_reduced$Bark_at_5cm)
# hist(log(clean_species_reduced$Bark_at_5cm)) #yes
# hist(clean_species_reduced$Bark_at_8mm)
# hist(log(clean_species_reduced$Bark_at_8mm)) #yes
# hist(clean_species_reduced$Wood_density)#no
clean_species_reduced_orig <- clean_species_reduced
clean_species_reduced_trans <- clean_species_reduced
#vars to log-trans
log_trans <- c(4, 5, 6, 9, 11, 12, 13)
#log-trans predictor variables
clean_species_reduced_trans[, log_trans] <- log(clean_species_reduced_trans[, log_trans])
clean_species_reduced <- clean_species_reduced_trans
# Bring in phylogeny
tree <- readRDS("phylogeny_code.RDS")
tree_pruned <- drop.tip(tree, setdiff(tree$tip.label, clean_species$Code))
# plot(tree_pruned, type = "fan")
#------------------------------------------------------------------------------
# What proportion of tree species sampled? For results section
#------------------------------------------------------------------------------
#calculate using both clean_species and clean_species_reduced
total_ba <- sum(plot_data$CSA_BH_expand, na.rm = TRUE)/10000
sampled_ba <- sum(plot_data[plot_data$Code %in% clean_species$Code, ]$CSA_BH_expand, na.rm = TRUE)/10000
sampled_ba/total_ba
plot_ba <- aggregate(plot_data[, c("P", "CSA_BH_expand")], by = list(plot_data$P), FUN = function(x){sum(x, na.rm=TRUE)})
sampled_plot_ba <- aggregate(plot_data[plot_data$Code %in% clean_species$Code, c("P", "CSA_BH_expand")],
by = list(plot_data[plot_data$Code %in% clean_species$Code, ]$P), FUN = function(x){sum(x, na.rm=TRUE)})
sampled_plot_ba$CSA_BH_expand / plot_ba$CSA_BH_expand
#------------------------------------------------------------------------------
# Bivariate analyses
#------------------------------------------------------------------------------
traits_names <- names(clean_species[-c(1:4, 13, 15, 16)])
# Calculate phylogenetic signal, ANOVA, Tukey's post-hoc, phylogenetic ANOVA
log_trans <- c(1, 2, 5, 7, 8)
#fix the tree
tree_pruned <- drop.tip(tree, setdiff(tree$tip.label, clean_species_reduced$Code)) # for phylogenetic ANOVA
#reorder species traits to match phylogeny
clean_species_ordered_orig <- clean_species_reduced_orig[match(tree_pruned$tip.label, clean_species_reduced_orig$Code), ] #reorder to match phylogeny
#intialize a table to catch all the results
pvals_table <- data.frame(matrix(ncol = 10, nrow = 9))
#t for tukey, p for phylogenetic comparison
names(pvals_table) <- c("Trait", "tG-S", "tF-S", "tF-G", "pG-S", "pF-S", "pF-G", "ANOVA", "phylANOVA", "lambda")
for (i in 1:length(traits_names)){
#trait name
pvals_table[i, 1] <- traits_names[i]
#fit an ANOVA
model <- lm(clean_species_reduced[, traits_names[i]] ~ as.factor(clean_species_reduced$FG))
aov <- aov(model)
#ANOVA p-value from F-test
pvals_table[i, 8] <- summary(aov)[[1]][[5]][[1]] #this is dumb; is this really the right way to extract the p-value?!
#calculate post-hoc phylogenetically-corrected differences and add letters to figure
tuke <- TukeyHSD(aov)
pvals <- tuke$`as.factor(clean_species_reduced$FG)`[, 4]
pvals_table[i, c(2:4)] <- pvals
#phylogenetic ANOVA
phyl_aov_results <- phylANOVA(tree = tree_pruned, x = clean_species_ordered_orig$FG,
y = clean_species_ordered_orig[, traits_names[i]],
nsim=1000, posthoc=TRUE, p.adj="holm")
pvals_table[i, 9] <- phyl_aov_results$Pf
pvals <- c(phyl_aov_results$Pt[2,1], phyl_aov_results$Pt[3,1], phyl_aov_results$Pt[3,2])
pvals_table[i, c(5:7)] <- pvals
#calculate the phylogenetic signal in the trait
sig <- phylosig(tree = tree_pruned, x = clean_species_ordered_orig[, traits_names[i]],
method="lambda", test=TRUE, nsim=1000)
pvals_table[i, 10] <- sig$lambda
}
write.csv(pvals_table, "./Model output/FG_traits_pvals.csv")
#---------------------------
# Figure 1: trait differences between functional groups
traits_names_clean <- c(expression(paste("Leaf size (cm"^"2", ")")),
"Leaf thickness (mm)",
"Max height (m)",
"Height at 5 cm dia. (m)",
"       Crown ratio\nat 5cm dia. (unitless)",
"         Light code\nat 5 cm dia. (unitless)",
expression(paste("Specific leaf area (cm"^"2", " g"^"-1", ")")),
"  Bark thickness\nat 5cm dia. (mm)",
expression(paste("Wood density (g cm"^"-3",")")))
tiff(filename="./plots/traits_by_FG.tiff",
type = "cairo",
antialias = "gray",
compression = "lzw",
units="in",
width = 4.5,
height=6,
pointsize=9,
res=600)
par(mfrow = c(3, 3),
mar = c(2,6,2,0.5),
oma = c(1, 0, 0, 0))
for (i in 1:length(traits_names)){
# model <- lm(clean_species_reduced[, traits_names[i]] ~ as.factor(clean_species_reduced$FG))
noise <- rnorm(nrow(clean_species_reduced), 0, .02)
means <- aggregate(clean_species_reduced_orig[, traits_names[i]], by = list(as.factor(clean_species_reduced$FG)),
FUN = mean)
if(!(i %in% log_trans)){
plot(clean_species_reduced[, traits_names[i]] ~ I(as.numeric(clean_species_reduced$FG) + noise),
xlab = "",
ylab = "",
xaxt = 'n',
xlim = c(0.8, 3.2),
ylim = c((0.8 * min(clean_species_reduced[, traits_names[i]], na.rm = TRUE, na.rm = TRUE)),
(1.2 * max(clean_species_reduced[, traits_names[i]], na.rm = TRUE))),
cex.lab = 1.3
)
}else{
plot(exp(clean_species_reduced[, traits_names[i]]) ~ I(as.numeric(clean_species_reduced$FG) + noise),
xlab = "",
ylab = "",
xaxt = 'n',
xlim = c(0.8, 3.2),
ylim = c((0.8 * min(exp(clean_species_reduced[, traits_names[i]]), na.rm = TRUE)),
(1.2 * max(exp(clean_species_reduced[, traits_names[i]]), na.rm = TRUE))),
cex.lab = 1.3
)
}
points(means[, 2] ~ c(1,2,3), pch = 18, cex = 2)
lines(means[, 2] ~ c(1,2,3), lty = 1, lwd = 2)
mtext(text = levels(clean_species_reduced$FG), side = 1, at = c(1,2,3), line = 1)
mtext(text = paste0("(", letters[i], ")") , side = 3, at = 0.4, line = .3)
mtext(text = traits_names_clean[i], side = 2, line = 1.9)
pvals <- as.numeric(pvals_table[i, c(5:7)])
names(pvals) <- c("G-S", "F-S", "F-G")
tuke_letters <- multcompLetters(pvals, reversed=TRUE)$Letters[c(3,1,2)]
#fixes letters sometimes being in the wrong order -- not sure why this happens?
if(tuke_letters[1] != "a"){
tuke_letters <- multcompLetters(pvals, reversed=FALSE)$Letters[c(3,1,2)]
}
#plot the tuke letters for phylogenetic ANOVA
ylim <- par("usr")[c(3,4)]
yrange <- ylim[2]-ylim[1]
text(x = c(1,2,3), y = ylim[2] - yrange/10, labels = tuke_letters, cex = 1.2)
#plot the lambda value
lam <- round(pvals_table$lambda[i], digits = 2)
mtext(text = eval(bquote(expression(lambda ~ "=" ~ .(lam)))) , side = 3, at = 2.5, line = .3, cex = 0.85)
}
dev.off()
#------------------------------------------------------------------------------
#PCA on traits
#------------------------------------------------------------------------------
pca_data <- scale(clean_species_reduced[, c("Total_leaf_size", "Leaf_thickness", "Max_height",
"Height_at_5cm", "Crown_ratio", "SLA",
"Bark_at_5cm", "Bark_at_8mm", "Wood_density", "Light_at_5cm")])
rownames(pca_data) <- clean_species_reduced$Code
pca_groups <- clean_species_reduced[, c("FG")]
pca_sp_names <- clean_species_reduced$Code
# pca_data <- pca_data[complete.cases(pca_data), ]
# pca_results <- prcomp(pca_data, scale. = T)
#run the PCA
pca_results <- rda(pca_data, scale = TRUE)
trait_names <- gsub("_", " ", rownames(pca_results$CA$v))
sp_scores <- scores(pca_results,  choices = c(1:10), display = c("sites"))
trait_scores <- scores(pca_results, choices = c(1:10), display = c("species"))
summary(pca_results)
biplot(pca_results, choices = c(1,3))
# ordihull(ord = pca_results, groups = factor(clean_species_reduced$FG))
tiff(filename="./plots/traits_PCA_axes_1_2.tiff",
type = "cairo",
antialias = "gray",
compression = "lzw",
units="in",
width = 7,
height=7,
pointsize=9,
res=600)
color_groups <- data.frame(group = as.character(c("F", "G", "S")),
col = as.character(c("black", "green", "dark orange")))
color_points <- as.character(color_groups[match(pca_groups, color_groups$group), "col"])
plot(NA,
xlab = "PC1", ylab = "PC2",
xlim = c( (min(c(sp_scores[, 1], trait_scores[, 1]) - .5)),
(max(c(sp_scores[, 1], trait_scores[, 1])) + 0.4)),
ylim = c( (min(c(sp_scores[, 2], trait_scores[, 2]) - .5)),
(max(c(sp_scores[, 2], trait_scores[, 2])) + 0.4)))
text(y = sp_scores[, 2], x = sp_scores[, 1], labels = pca_sp_names, col = color_points, cex = .7)
# points(y = sp_scores[, 2], x = sp_scores[, 1], col = color_points, bg = color_points, pch = 21, cex = .7)
abline(h = 0)
abline(v = 0)
for(i in 1:3){
ordiellipse(pca_results, pca_groups, show.groups = color_groups[i, 1],
col = as.character(color_groups[i, 2]), choices = c(1,2),
kind = "sd", conf = 0.90)
}
legend(x = par()$usr[1], y = par()$usr[4],
legend = c("Forest", "Generalist", "Savanna"),
col = c("black", "green", "dark orange"),
pt.bg = c("black", "green", "dark orange"),
pch = 21,
cex = 1.5,
bty = "n")
segments(x0 = 0, y0 = 0, x1 = trait_scores[, 1], y1 = trait_scores[, 2])
# yoffsets <- c(-0.05, .05, -.07, -.08, .05, -.05, -.05, -.04, 0.05, -.1)
# xoffsets <- c(0, -.05, 0, 0.2, -.05, 0, -.2, -.2, 0, 0.2)
yoffsets <- 0
xoffesets <- 0
text(x = trait_scores[, 1], y = trait_scores[, 2], labels = trait_names, cex = 1.3)
dev.off()
#################
# PCs 1 + 3
tiff(filename="./plots/traits_PCA_axes_1_3.tiff",
type = "cairo",
antialias = "gray",
compression = "lzw",
units="in",
width = 7,
height=7,
pointsize=9,
res=600)
color_groups <- data.frame(group = as.character(c("F", "G", "S")),
col = as.character(c("black", "green", "dark orange")))
color_points <- as.character(color_groups[match(pca_groups, color_groups$group), "col"])
plot(NA,
xlab = "PC1", ylab = "PC3",
xlim = c( (min(c(sp_scores[, 1], trait_scores[, 1]) - .5)),
(max(c(sp_scores[, 1], trait_scores[, 1])) + 0.4)),
ylim = c( (min(c(sp_scores[, 3], trait_scores[, 3]) - .5)),
(max(c(sp_scores[, 3], trait_scores[, 3])) + 0.4)))
text(y = sp_scores[, 3], x = sp_scores[, 1], labels = pca_sp_names, col = color_points, cex = .7)
# points(y = sp_scores[, 2], x = sp_scores[, 1], col = color_points, bg = color_points, pch = 21, cex = .7)
abline(h = 0)
abline(v = 0)
for(i in 1:3){
ordiellipse(pca_results, pca_groups, show.groups = color_groups[i, 1],
col = as.character(color_groups[i, 2]), choices = c(1,3),
kind = "sd", conf = 0.90)
}
legend(x = par()$usr[1], y = par()$usr[4],
legend = c("Forest", "Generalist", "Savanna"),
col = c("black", "green", "dark orange"),
pt.bg = c("black", "green", "dark orange"),
pch = 21,
cex = 1.5,
bty = "n")
segments(x0 = 0, y0 = 0, x1 = trait_scores[, 1], y1 = trait_scores[, 3])
# yoffsets <- c(-0.05, .05, -.07, -.08, .05, -.05, -.05, -.04, 0.05, -.1)
# xoffsets <- c(0, -.05, 0, 0.2, -.05, 0, -.2, -.2, 0, 0.2)
yoffsets <- 0
xoffesets <- 0
text(x = trait_scores[, 1], y = trait_scores[, 3], labels = trait_names, cex = 1.3)
dev.off()
#-----------------------------------------------------------------------------
# Phylogenetic PCA
#-----------------------------------------------------------------------------
tree_pruned <- drop.tip(tree, setdiff(tree$tip.label, clean_species_reduced$Code))
clean_species_ordered <- clean_species_reduced[match(tree_pruned$tip.label, clean_species_reduced$Code), ]
phy_pca_data <- scale(clean_species_ordered[, c("Total_leaf_size", "Leaf_thickness", "Max_height",
"Height_at_5cm", "Crown_ratio", "SLA",
"Bark_at_5cm", "Bark_at_8mm", "Wood_density", "Light_at_5cm")])
rownames(phy_pca_data) <- clean_species_ordered$Code
phy_pca_groups <- clean_species_ordered[, c("FG")]
phy_pca_sp_names <- clean_species_ordered$Code
#run the PCA
phy_pca_results <- phyl.pca(tree = tree_pruned, Y = phy_pca_data[match(tree_pruned$tip.label, rownames(phy_pca_data)), ], method="BM", mode="cov")
phy_trait_names <- gsub("_", " ", rownames(phy_pca_results$Evec))
phy_sp_scores <- phy_pca_results$S
phy_trait_scores <- phy_pca_results$L * 3
summary(phy_pca_results)
biplot(phy_pca_results)
tiff(filename="./plots/traits_phylo_PCA_axes_1_2.tiff",
type = "cairo",
antialias = "gray",
compression = "lzw",
units="in",
width = 7,
height=7,
pointsize=9,
res=600)
color_groups <- data.frame(group = as.character(c("F", "G", "S")),
col = as.character(c("black", "green", "dark orange")))
color_points <- as.character(color_groups[match(phy_pca_groups, color_groups$group), "col"])
plot(NA,
xlab = "PC1", ylab = "PC2",
xlim = c( (min(c(phy_sp_scores[, 1], phy_trait_scores[, 1]) - .5)),
(max(c(phy_sp_scores[, 1], phy_trait_scores[, 1])) + 0.4)),
ylim = c( (min(c(phy_sp_scores[, 2], phy_trait_scores[, 2]) - .5)),
(max(c(phy_sp_scores[, 2], phy_trait_scores[, 2])) + 0.4)))
text(y = phy_sp_scores[, 2], x = phy_sp_scores[, 1], labels = phy_pca_sp_names, col = color_points, cex = .7)
# points(y = sp_scores[, 2], x = sp_scores[, 1], col = color_points, bg = color_points, pch = 21, cex = .7)
abline(h = 0)
abline(v = 0)
for(i in 1:3){
phyellipse(ord = phy_pca_results, groups = factor(clean_species_ordered$FG),
show.groups = color_groups[i, 1],
col = as.character(color_groups[i, 2]),
choices = c(1,2),
kind = "sd",
conf = 0.95)
}
legend(x = par()$usr[1], y = par()$usr[4],
legend = c("Forest", "Generalist", "Savanna"),
col = c("black", "green", "dark orange"),
pt.bg = c("black", "green", "dark orange"),
pch = 21,
cex = 1.5,
bty = "n")
segments(x0 = 0, y0 = 0, x1 = phy_trait_scores[, 1], y1 = phy_trait_scores[, 2])
yoffsets <- c(-0.05, .05, -.07, -.08, .05, -.05, -.05, -.04, 0.05, -.1)
xoffsets <- c(0, -.05, 0, 0.2, -.05, 0, -.2, -.2, 0, 0.2)
text(x = phy_trait_scores[, 1], y = phy_trait_scores[, 2], labels = phy_trait_names, cex = 1.3)
dev.off()
#######################
# PCs 1 = 3
tiff(filename="./plots/traits_phylo_PCA_axes_1_3.tiff",
type = "cairo",
antialias = "gray",
compression = "lzw",
units="in",
width = 7,
height=7,
pointsize=9,
res=600)
color_groups <- data.frame(group = as.character(c("F", "G", "S")),
col = as.character(c("black", "green", "dark orange")))
color_points <- as.character(color_groups[match(phy_pca_groups, color_groups$group), "col"])
plot(NA,
xlab = "PC1", ylab = "PC3",
xlim = c( (min(c(phy_sp_scores[, 1], phy_trait_scores[, 1]) - .5)),
(max(c(phy_sp_scores[, 1], phy_trait_scores[, 1])) + 0.4)),
ylim = c( (min(c(phy_sp_scores[, 3], phy_trait_scores[, 3]) - .5)),
(max(c(phy_sp_scores[, 3], phy_trait_scores[, 3])) + 0.4)))
text(y = phy_sp_scores[, 3], x = phy_sp_scores[, 1], labels = phy_pca_sp_names, col = color_points, cex = .7)
# points(y = sp_scores[, 2], x = sp_scores[, 1], col = color_points, bg = color_points, pch = 21, cex = .7)
abline(h = 0)
abline(v = 0)
for(i in 1:3){
phyellipse(ord = phy_pca_results, groups = factor(clean_species_ordered$FG),
show.groups = color_groups[i, 1],
col = as.character(color_groups[i, 2]),
kind = "ehull",
choices = c(2,3))
}
legend(x = par()$usr[1], y = par()$usr[4],
legend = c("Forest", "Generalist", "Savanna"),
col = c("black", "green", "dark orange"),
pt.bg = c("black", "green", "dark orange"),
pch = 21,
cex = 1.5,
bty = "n")
segments(x0 = 0, y0 = 0, x1 = phy_trait_scores[, 1], y1 = phy_trait_scores[, 3])
yoffsets <- c(-0.05, .05, -.07, -.08, .05, -.05, -.05, -.04, 0.05, -.1)
xoffsets <- c(0, -.05, 0, 0.2, -.05, 0, -.2, -.2, 0, 0.2)
text(x = phy_trait_scores[, 1], y = phy_trait_scores[, 3], labels = phy_trait_names, cex = 1.3)
dev.off()
# #---------------------------------------------------------------------------------------------
# Tables for supplement
#--------------------------------------------------------------------------------------------
species_scores_table <- as.data.frame(cbind(as.character(pca_sp_names),
as.character(clean_species_reduced$FG),
sp_scores))
names(species_scores_table)[c(1,2)] <- c("Species Code", "Functional Type")
write.csv(species_scores_table, "./Model output/species_score_table.csv")
#--------------------------------------------------------------------------
# Checking differences between functional groups
#---------------------------------------------------------------------------
library("Hotelling")
hotelling_results <- data.frame("H2" = numeric(3),
"H2phy" = numeric(3))
groups <- matrix(data = c("S", "G", "S", "F", "G", "F"), nrow = 3, ncol = 2, byrow = TRUE)
pca_results_out <- cbind(as.data.frame(sp_scores), pca_groups)
names(pca_results_out)[11] <- "FG"
phy_results_out <- cbind(as.data.frame(phy_sp_scores), clean_species_ordered$FG)
names(phy_results_out)[11] <- "FG"
for(i in 1:3){
h2_pca <- hotelling.test(x = pca_results_out[pca_results_out$FG == groups[i, 1], c(1,2)],
y = pca_results_out[pca_results_out$FG == groups[i, 2], c(1,2)],
perm = FALSE)
hotelling_results[i, 1] <- h2_pca$pval
h2_phy <- hotelling.test(x = sp_scores[clean_species_ordered$FG == groups[i, 1], c(1,2)],
y = sp_scores[clean_species_ordered$FG == groups[i, 2], c(1,2)],
perm = FALSE)
hotelling_results[i, 2] <- h2_phy$pval
}
#*******************************************************************************************
# Estimating trait distributions for plots
#*******************************************************************************************
#create new columns to fill
plot_data$Leaf_size <- NA
plot_data$Leaf_thickness <- NA
plot_data$Height_at_5cm <- NA
plot_data$Max_height <- NA
plot_data$Crown_ratio <- NA
plot_data$SLA <- NA
plot_data$Bark_at_5cm <- NA
plot_data$Bark_at_8mm <- NA
plot_data$est_bark_thickness <- NA
plot_data$Wood_density <- NA
plot_data$Light_at_5cm <- NA
was_measured <- plot_data$Code %in% clean_species$Code
# estimate traits for entries in the plot data
for(i in 1:nrow(plot_data)){#this is surely the worst way to do this
if(was_measured[i]){
plot_data$Leaf_size[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Total_leaf_size"]
plot_data$Leaf_thickness[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Leaf_thickness"]
plot_data$Height_at_5cm[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Height_at_5cm"]
plot_data$Max_height[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Max_height"]
plot_data$Crown_ratio[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Crown_ratio"]
plot_data$SLA[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "SLA"]
plot_data$Bark_at_5cm[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Bark_at_5cm"]
plot_data$Bark_at_8mm[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Bark_at_8mm"]
plot_data$est_bark_thickness[i] <- predict(bark_model, newdata = list(max_d30 = plot_data$Max_D30[i], Code = plot_data$Code[i]))
plot_data$Wood_density[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Wood_density"]
plot_data$Light_at_5cm[i] <- clean_species[clean_species$Code == as.character(plot_data$Code[i]), "Light_at_5cm"]
}
}
trait_summary <- aggregate(plot_data[, c(6, 19:30)], by = list(plot_data$FG, plot_data$Life.Form), FUN = mean, na.rm = TRUE)
